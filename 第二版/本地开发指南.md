# 🖥️ 本地开发环境设置指南

本指南将帮助您在本地电脑上运行和测试整个项目，无需部署到 Netlify。

---

## 📋 前提条件

### 必须安装的软件

1. **Node.js** (v18 或更高版本)
   - 下载地址：https://nodejs.org/
   - 验证安装：`node --version`

2. **npm** (通常随 Node.js 一起安装)
   - 验证安装：`npm --version`

3. **Git** (可选，用于版本控制)
   - 下载地址：https://git-scm.com/

---

## 🚀 快速开始

### 步骤 1：安装 Netlify CLI

打开命令行（Windows: PowerShell/CMD，Mac/Linux: Terminal），执行：

```bash
npm install -g netlify-cli
```

验证安装成功：

```bash
netlify --version
```

应该看到类似：`netlify-cli/17.x.x`

---

### 步骤 2：进入项目目录

```bash
cd /path/to/your/project/第二版
```

**Windows 示例：**
```bash
cd C:\Users\YourName\Documents\web\第二版
```

**Mac/Linux 示例：**
```bash
cd ~/Documents/web/第二版
```

---

### 步骤 3：安装项目依赖

```bash
npm install
```

这会安装 `package.json` 中定义的所有依赖，包括 `@supabase/supabase-js`。

---

### 步骤 4：创建本地环境变量文件

在 `第二版` 目录下创建一个名为 `.env` 的文件：

**Windows (PowerShell)：**
```powershell
New-Item .env -ItemType File
```

**Mac/Linux：**
```bash
touch .env
```

**或者直接用文本编辑器创建 `.env` 文件**

---

### 步骤 5：配置环境变量

在 `.env` 文件中添加以下内容（替换为你的实际值）：

```bash
# Supabase 配置
SUPABASE_URL=https://xxxxxxxxxxxxx.supabase.co
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.xxxxxxx
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.xxxxxxx

# CORS 允许的域名（本地开发）
ALLOWED_ORIGINS=http://localhost:8888,http://127.0.0.1:8888
```

**如何获取这些值：**
1. 登录 [Supabase Dashboard](https://supabase.com/dashboard)
2. 选择你的项目
3. 进入 Settings > API
4. 复制 URL 和密钥

**⚠️ 重要提示：**
- `.env` 文件包含敏感信息，千万不要提交到 Git
- 已经在 `.gitignore` 中排除了 `.env` 文件

---

### 步骤 6：启动本地开发服务器

```bash
netlify dev
```

**第一次运行时，Netlify CLI 可能会问：**
- "What command should we run to start your dev server?" → 回车（选择默认）
- "What port does your dev server run on?" → 输入 `8888` 或直接回车

**启动成功后，你会看到：**
```
┌─────────────────────────────────────────────────┐
│                                                 │
│   ◈ Server now ready on http://localhost:8888  │
│                                                 │
└─────────────────────────────────────────────────┘
```

---

## 🌐 访问本地网站

### 主页
```
http://localhost:8888/index.html
或
http://localhost:8888/
```

### 管理员后台
```
http://localhost:8888/admin.html
```

### 测试 API
```
http://localhost:8888/.netlify/functions/config
```

---

## 🔧 本地开发工作流程

### 1. 修改代码

在你喜欢的编辑器中修改代码：
- `index.html` - 主页
- `admin.html` - 管理员后台
- `script.js` - 前端逻辑
- `admin-script.js` - 管理员逻辑
- `netlify/functions/*.js` - API 函数

### 2. 自动重载

Netlify Dev 会自动监测文件变化：
- **HTML/CSS/JS 修改** → 自动刷新浏览器
- **API 函数修改** → 自动重启函数

### 3. 查看日志

**前端日志：** 浏览器开发者工具（F12）

**API 日志：** 命令行窗口会显示所有 API 请求和错误

**示例输出：**
```
◈ Request from ::1: POST /.netlify/functions/register
◈ Response with status 200 in 123ms
```

### 4. 调试技巧

**前端调试：**
```javascript
console.log('当前用户:', currentUser);
console.log('配置信息:', config);
```

**API 调试：**
在 API 函数中添加：
```javascript
console.log('收到请求:', event.body);
console.log('用户信息:', user);
```

---

## 📁 项目结构

```
第二版/
├── .env                          # 本地环境变量 ⚠️ 不要提交到 Git
├── .gitignore                    # Git 忽略文件
├── netlify.toml                  # Netlify 配置
├── package.json                  # 项目依赖
├── index.html                    # 主页
├── admin.html                    # 管理员后台
├── script.js                     # 主页 JS
├── admin-script.js               # 管理员 JS
├── styles.css                    # 样式
└── netlify/functions/            # API 函数
    ├── config.js
    ├── register.js
    ├── create-profile.js
    ├── admin-roles.js
    ├── approvals.js
    ├── admin-events.js
    ├── admin-finance.js
    └── admin-inventory.js
```

---

## 🧪 测试本地功能

### 测试 1：配置 API

打开浏览器访问：
```
http://localhost:8888/.netlify/functions/config
```

**期望返回：**
```json
{
  "supabaseUrl": "https://xxxxx.supabase.co",
  "supabaseAnonKey": "eyJ..."
}
```

### 测试 2：用户注册

1. 访问 `http://localhost:8888/`
2. 点击"登录/注册"
3. 切换到"注册"模式
4. 填写信息并提交

**检查：**
- 浏览器控制台（F12）是否有错误
- 命令行是否显示 API 请求
- Supabase Dashboard 中是否创建了用户

### 测试 3：用户登录

1. 输入邮箱和密码
2. 点击登录

**检查：**
- 是否显示用户名
- 是否可以报名活动

### 测试 4：管理员后台

1. 访问 `http://localhost:8888/admin.html`
2. 使用管理员账号登录

**检查：**
- 是否显示管理员后台
- 是否可以查看待审批事项

---

## 🔄 部署到 Netlify

### 当本地测试完成后，部署步骤：

#### 方法 1：Git 自动部署（推荐）

```bash
# 1. 提交代码
git add .
git commit -m "完成本地测试，准备部署"

# 2. 推送到 GitHub
git push origin your-branch-name

# 3. Netlify 会自动检测并部署
```

#### 方法 2：手动部署

```bash
# 在项目目录下执行
netlify deploy --prod
```

**⚠️ 注意：**
- 手动部署前确保 Netlify 环境变量已配置
- Git 部署更安全，推荐使用

---

## ⚙️ 高级配置

### 自定义端口

如果 8888 端口被占用，修改 `netlify.toml`：

```toml
[dev]
  port = 3000  # 使用 3000 端口
```

### 禁用自动打开浏览器

```bash
netlify dev --no-open
```

### 查看所有可用命令

```bash
netlify dev --help
```

---

## 🐛 常见问题

### 问题 1：端口被占用

**错误信息：**
```
Error: Port 8888 is already in use
```

**解决方法：**
1. 关闭占用端口的程序
2. 或修改 `netlify.toml` 使用其他端口

### 问题 2：环境变量未加载

**症状：** API 返回 "Supabase 配置缺失"

**解决方法：**
1. 确认 `.env` 文件在正确位置
2. 重启 `netlify dev`
3. 检查环境变量格式（不要有空格）

### 问题 3：API 函数报错

**症状：** 500 错误

**解决方法：**
1. 查看命令行的错误日志
2. 检查 API 函数代码
3. 确认 `package.json` 中的依赖已安装

### 问题 4：CORS 错误

**症状：** 浏览器控制台显示 CORS 错误

**解决方法：**
1. 确认 `.env` 中有 `ALLOWED_ORIGINS`
2. 确认值包含 `http://localhost:8888`
3. 重启开发服务器

---

## 📊 本地 vs Netlify 对比

| 特性 | 本地开发 | Netlify 生产 |
|------|----------|--------------|
| 速度 | ⚡ 即时 | 🐢 需要构建 |
| 调试 | ✅ 完整日志 | ⚠️ 有限日志 |
| 成本 | 💰 免费 | 💸 消耗配额 |
| 环境 | 🏠 本地数据库 | ☁️ 生产数据库 |
| 适用场景 | 开发、测试 | 正式发布 |

---

## 💡 开发建议

### 最佳实践

1. **本地优先**
   - 所有新功能先在本地开发和测试
   - 确认无误后再推送到 Netlify

2. **频繁提交**
   - 完成一个小功能就提交一次
   - 提交信息要清晰描述改动

3. **分支开发**
   - 新功能使用新分支
   - 测试通过后再合并到主分支

4. **环境隔离**
   - 本地测试使用测试数据
   - 生产环境使用真实数据

### 推荐工作流程

```
1. 本地开发 (netlify dev)
   ↓
2. 本地测试 (http://localhost:8888)
   ↓
3. 提交代码 (git commit)
   ↓
4. 推送到 GitHub (git push)
   ↓
5. Netlify 自动部署
   ↓
6. 生产环境测试
```

---

## 🔐 安全提示

### .env 文件安全

**✅ 应该做：**
- 保存在 `.gitignore` 中
- 定期更新密钥
- 不同环境使用不同密钥

**❌ 不应该做：**
- 提交到 Git
- 分享给他人
- 在公开场合展示

### 密钥管理

**本地开发：**
```
.env 文件 → 仅用于本地开发
```

**生产环境：**
```
Netlify 环境变量 → 仅用于生产部署
```

---

## 📚 额外资源

### Netlify CLI 文档
https://docs.netlify.com/cli/get-started/

### Supabase 本地开发
https://supabase.com/docs/guides/local-development

### Node.js 文档
https://nodejs.org/docs/

---

## 🎉 开始本地开发！

执行以下命令开始：

```bash
cd 第二版
npm install
netlify dev
```

访问：`http://localhost:8888`

祝开发顺利！🚀
