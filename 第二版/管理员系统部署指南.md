# 管理员系统部署指南

## 📋 概述

本指南介绍如何部署和使用新的管理员系统功能，包括：
- 管理员角色管理
- 审批流程系统
- 扩展的活动管理
- 财务管理
- 物资管理

## 🗄️ 数据库迁移

### 步骤 1：执行数据库迁移脚本

1. 登录到 [Supabase Dashboard](https://supabase.com/dashboard)
2. 选择你的项目
3. 进入 SQL Editor
4. 打开 `admin_system_migration.sql` 文件
5. 复制所有内容并粘贴到 SQL Editor
6. 点击 "Run" 执行脚本

### 步骤 2：验证数据库表创建成功

执行以下 SQL 查询验证：

```sql
-- 查看所有新表
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public'
AND table_name IN ('admin_roles', 'approval_requests', 'event_tickets');
```

应该看到 3 个表都已创建。

## 🔐 任命首位社长

数据库迁移完成后，需要手动任命第一位社长。

### 方法 1：使用 SQL（推荐）

1. 在 Supabase SQL Editor 中执行：

```sql
-- 将用户任命为社长
-- 替换 'USER_UUID' 为实际的用户 UUID（可在 auth.users 表中查找）
INSERT INTO admin_roles (user_id, role, is_active)
VALUES ('USER_UUID', 'president', TRUE);
```

2. 查找用户 UUID：

```sql
-- 查看所有已注册用户
SELECT
    u.id AS user_id,
    p.real_name,
    p.student_id,
    u.email
FROM auth.users u
LEFT JOIN profiles p ON u.id = p.id
ORDER BY u.created_at DESC;
```

### 方法 2：使用 Supabase Dashboard

1. 进入 Supabase Dashboard > Table Editor
2. 打开 `admin_roles` 表
3. 点击 "Insert row"
4. 填写以下信息：
   - `user_id`: 选择用户的 UUID
   - `role`: 选择 `president`
   - `is_active`: 选择 `true`
5. 点击 "Save"

## 🚀 部署新文件

### 确认所有文件已上传到 Netlify

确保以下文件已存在于你的项目中：

```
/第二版/
├── admin.html                  # 管理员后台页面
├── admin-script.js             # 管理员后台 JS
├── admin_system_migration.sql  # 数据库迁移脚本
└── netlify/functions/
    ├── admin-roles.js          # 角色管理 API
    ├── approvals.js            # 审批流程 API
    ├── admin-events.js         # 活动管理 API
    ├── admin-finance.js        # 财务管理 API
    └── admin-inventory.js      # 物资管理 API
```

### Netlify 部署方式

#### 方式 1：Git 连接（推荐）

1. 将代码推送到 Git 仓库
2. Netlify 会自动检测更改并重新部署

#### 方式 2：手动拖拽

1. 登录 Netlify Dashboard
2. 进入你的站点
3. 拖拽整个 `第二版` 文件夹到 Netlify
4. 等待部署完成

## 🔧 配置环境变量

确保 Netlify 中已配置以下环境变量：

```
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=eyJhbGc...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGc...  ⚠️ 私密！
```

## 📱 使用管理员系统

### 访问管理员后台

1. 访问：`https://your-site.netlify.app/admin.html`
2. 如果未登录，会自动跳转到登录页
3. 登录后，如果是管理员，会看到管理员后台

### 各角色功能说明

#### 🏆 社长（President）

**可用功能：**
- ✅ 任免管理员
- ✅ 审批所有待办事项
- ✅ 直接创建/编辑/删除活动（无需审批）
- ✅ 直接管理财务记录（无需审批）
- ✅ 直接管理物资（无需审批）

**操作流程：**
1. 进入"待审批"标签页查看待办事项
2. 点击"批准"或"拒绝"按钮处理审批
3. 进入"角色管理"任命或撤销管理员

#### 💰 财务（Treasurer）

**可用功能：**
- ✅ 添加/编辑/删除财务记录（需要社长审批）
- ✅ 添加/编辑/删除物资（需要社长审批）
- ✅ 查看"我的申请"跟踪审批状态

**操作流程：**
1. 进入"财务管理"标签页
2. 点击"添加记录"按钮
3. 填写表单并提交
4. 等待社长审批
5. 在"我的申请"中查看审批状态

#### 👥 副社长（Vice President）

**可用功能：**
- ✅ 创建/编辑/删除活动（需要社长审批）
- ✅ 查看"我的申请"跟踪审批状态

#### 🏸 活动部部长（Activity Director）

**可用功能：**
- ✅ 创建/编辑/删除活动（需要社长审批）
- ✅ 查看"我的申请"跟踪审批状态

#### 👨‍🏫 指导老师（Advisor）

**可用功能：**
- 👁️ 查看活动
- 👁️ 查看财务
- 👁️ 查看物资
- ❌ 无编辑权限

## 🎯 常见操作示例

### 1. 社长任命新的财务

1. 社长登录管理员后台
2. 进入"角色管理"标签页
3. 点击"任命管理员"按钮
4. 选择用户和角色（财务）
5. 确认任命

### 2. 财务添加社费收入记录

1. 财务登录管理员后台
2. 进入"财务管理"标签页
3. 点击"添加记录"按钮
4. 填写：
   - 类型：收入
   - 金额：50
   - 描述：社费收入
5. 提交申请
6. 等待社长审批

### 3. 社长审批财务申请

1. 社长登录管理员后台
2. 进入"待审批"标签页
3. 找到财务的申请
4. 点击"批准"或"拒绝"
5. 填写审批备注（可选）
6. 确认

### 4. 副社长创建新活动

1. 副社长登录管理员后台
2. 进入"活动管理"标签页
3. 点击"创建活动"按钮
4. 填写活动信息：
   - 标题：周末羽毛球活动
   - 类型：周常群打
   - 描述：周末打球活动
5. 提交申请
6. 等待社长审批

### 5. 社长直接创建活动

1. 社长登录管理员后台
2. 进入"活动管理"标签页
3. 点击"创建活动"按钮
4. 填写活动信息
5. 确认创建（无需审批，直接生效）

## 🐛 故障排除

### 问题 1：无法访问管理员后台

**可能原因：**
- 用户未登录
- 用户不是管理员

**解决方法：**
1. 确保已登录
2. 检查数据库中 `admin_roles` 表，确认用户有活跃的管理员角色
3. 刷新页面

### 问题 2：API 返回 403 错误

**可能原因：**
- 用户角色不正确
- RLS 策略问题

**解决方法：**
1. 检查用户的管理员角色是否 `is_active = TRUE`
2. 检查数据库 RLS 策略是否正确执行
3. 查看浏览器控制台的错误信息

### 问题 3：审批后操作未生效

**可能原因：**
- `executeApprovedAction` 函数执行失败

**解决方法：**
1. 检查 Netlify Functions 日志
2. 查看 `approvals.js` 中的错误日志
3. 确保数据库表结构正确

### 问题 4：无法任命管理员

**可能原因：**
- 用户已有活跃的管理员角色
- 当前用户不是社长

**解决方法：**
1. 检查目标用户是否已有角色
2. 如果有，先撤销旧角色再任命新角色
3. 确认当前用户是社长

## 📊 数据库表说明

### admin_roles 表

管理员角色表，记录所有管理员信息。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGSERIAL | 主键 |
| user_id | UUID | 用户 ID |
| role | TEXT | 角色（president/treasurer/vice_president/activity_director/advisor） |
| appointed_by | UUID | 任命人 |
| appointed_at | TIMESTAMP | 任命时间 |
| is_active | BOOLEAN | 是否在职 |

### approval_requests 表

审批请求表，记录所有需要审批的操作。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGSERIAL | 主键 |
| request_type | TEXT | 请求类型（finance_add/event_create 等） |
| requester_id | UUID | 申请人 |
| approver_id | UUID | 审批人 |
| status | TEXT | 状态（pending/approved/rejected） |
| request_data | JSONB | 请求数据 |
| reason | TEXT | 申请理由 |
| approval_note | TEXT | 审批备注 |
| target_id | BIGINT | 目标记录 ID |

### event_tickets 表

活动票表，用于多票管理（周常群打）。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGSERIAL | 主键 |
| group_id | BIGINT | 分组 ID |
| ticket_number | INTEGER | 票号 |
| capacity | INTEGER | 容量 |
| claimed | INTEGER | 已领取 |
| qr_code_url | TEXT | 二维码 URL |

## 🔄 升级现有数据

如果你已经有现有的活动数据，可能需要更新：

```sql
-- 更新现有活动，设置默认类型
UPDATE events SET type = 'group_play' WHERE type IS NULL;

-- 更新现有活动分组，设置默认票数
UPDATE event_groups
SET ticket_count = 1, capacity_per_ticket = capacity
WHERE ticket_count IS NULL;

-- 标记现有财务和物资记录为已批准
UPDATE finance_records SET approved = TRUE WHERE approved IS NULL;
UPDATE inventory SET approved = TRUE WHERE approved IS NULL;
```

## 📞 支持

如有问题，请：
1. 查看浏览器控制台错误信息
2. 查看 Netlify Functions 日志
3. 检查 Supabase 日志
4. 参考本指南的故障排除部分

## 📝 更新日志

### v2.0.0 (2026-01-11)

**新增功能：**
- ✨ 管理员角色系统（5种角色）
- ✨ 审批流程系统
- ✨ 完整的管理员后台
- ✨ 财务管理功能
- ✨ 物资管理功能
- ✨ 扩展的活动管理（支持多种类型）
- ✨ 多票活动支持

**数据库变更：**
- 新增 `admin_roles` 表
- 新增 `approval_requests` 表
- 新增 `event_tickets` 表
- 扩展 `events` 表（新增 type、registration_link 等字段）
- 扩展 `finance_records` 表（新增审批相关字段）
- 扩展 `inventory` 表（新增审批相关字段）

**API 新增：**
- `/.netlify/functions/admin-roles` - 角色管理
- `/.netlify/functions/approvals` - 审批流程
- `/.netlify/functions/admin-events` - 活动管理
- `/.netlify/functions/admin-finance` - 财务管理
- `/.netlify/functions/admin-inventory` - 物资管理

## 🎉 完成！

恭喜！你已经成功部署了管理员系统。现在可以：
1. 任命管理员团队
2. 使用审批流程规范管理
3. 通过网页直接管理社团事务

祝你使用愉快！🏸
