# 🚀 部署检查清单

请按照以下步骤完成部署，确保不遗漏任何配置！

## ✅ 第一步：配置 Supabase 数据库

### 1.1 执行基础数据库脚本

1. 登录 [Supabase Dashboard](https://supabase.com/dashboard)
2. 选择你的项目（如果没有，需要先创建）
3. 点击左侧菜单的 **SQL Editor**
4. 点击 **New query**
5. 复制 `database.sql` 文件的全部内容
6. 粘贴到编辑器并点击 **Run**

**验证：** 执行成功后，应该看到以下表已创建：
- profiles
- events
- event_groups
- registrations
- finance_records
- inventory

### 1.2 执行管理员系统迁移脚本

1. 在 SQL Editor 中点击 **New query**
2. 复制 `admin_system_migration.sql` 文件的全部内容
3. 粘贴到编辑器并点击 **Run**

**验证：** 执行成功后，应该看到以下新表：
- admin_roles（管理员角色）
- approval_requests（审批请求）
- event_tickets（活动票）

### 1.3 任命首位社长

1. 在 SQL Editor 中执行以下查询，找到你的用户 ID：

```sql
-- 查看所有已注册用户
SELECT
    u.id AS user_id,
    p.real_name,
    p.student_id,
    u.email
FROM auth.users u
LEFT JOIN profiles p ON u.id = p.id
ORDER BY u.created_at DESC;
```

2. 复制你想要任命为社长的用户的 `user_id`

3. 执行以下命令任命社长（替换 `YOUR_USER_ID`）：

```sql
-- 任命社长
INSERT INTO admin_roles (user_id, role, is_active)
VALUES ('YOUR_USER_ID', 'president', TRUE);
```

**验证：** 执行以下查询确认：

```sql
SELECT
    ar.role,
    p.real_name,
    p.student_id
FROM admin_roles ar
JOIN profiles p ON ar.user_id = p.id
WHERE ar.is_active = TRUE;
```

应该看到一条记录显示社长信息。

---

## ✅ 第二步：获取 Supabase 密钥

### 2.1 获取项目 URL

1. 在 Supabase Dashboard 中
2. 点击左侧的 **Project Settings**（齿轮图标）
3. 点击 **API**
4. 找到 **Project URL**，复制它
   - 格式类似：`https://xxxxxxxxxxxxx.supabase.co`

### 2.2 获取 API 密钥

在同一页面找到：

1. **anon public（公开密钥）**
   - 这个密钥是公开的，用于前端
   - 点击眼睛图标显示，然后复制

2. **service_role（服务密钥）**
   - ⚠️ **这个密钥是私密的，千万不要泄露！**
   - 点击眼睛图标显示，然后复制
   - 这个密钥用于后端 API，拥有完全权限

### 2.3 记录密钥

将以下信息保存到安全的地方（例如密码管理器）：

```
SUPABASE_URL=https://xxxxxxxxxxxxx.supabase.co
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.xxx...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.xxx...
```

---

## ✅ 第三步：配置 Netlify 环境变量

### 3.1 登录 Netlify

1. 访问 [Netlify Dashboard](https://app.netlify.com/)
2. 登录你的账号
3. 选择你的站点（如果没有，需要先部署，见下方）

### 3.2 添加环境变量

1. 点击 **Site settings**
2. 点击左侧菜单的 **Environment variables**
3. 点击 **Add a variable** 或 **Add environment variables**

添加以下 3 个环境变量：

#### 变量 1：SUPABASE_URL
- **Key:** `SUPABASE_URL`
- **Value:** 你在第二步获取的 Project URL
- **Scopes:** 选择所有（All scopes）

#### 变量 2：SUPABASE_ANON_KEY
- **Key:** `SUPABASE_ANON_KEY`
- **Value:** 你在第二步获取的 anon public 密钥
- **Scopes:** 选择所有（All scopes）

#### 变量 3：SUPABASE_SERVICE_ROLE_KEY
- **Key:** `SUPABASE_SERVICE_ROLE_KEY`
- **Value:** 你在第二步获取的 service_role 密钥
- **Scopes:** 选择所有（All scopes）
- ⚠️ **重要：这是私密密钥，不要分享给任何人！**

### 3.3 重新部署

配置环境变量后，需要重新部署：

1. 在 Netlify Dashboard 中
2. 点击 **Deploys** 标签
3. 点击 **Trigger deploy** > **Deploy site**

---

## ✅ 第四步：部署网站到 Netlify

### 方法 1：通过 Git 自动部署（推荐）

#### 4.1 连接 GitHub 仓库

1. 登录 [Netlify Dashboard](https://app.netlify.com/)
2. 点击 **Add new site** > **Import an existing project**
3. 选择 **GitHub**
4. 授权 Netlify 访问你的 GitHub
5. 选择仓库 `HaoranLuo/web`

#### 4.2 配置构建设置

- **Branch to deploy:** 选择 `claude/add-admin-management-8H4YF` 或合并后的主分支
- **Base directory:** 输入 `第二版`
- **Build command:** 留空（静态网站不需要构建）
- **Publish directory:** 输入 `.`（当前目录）

#### 4.3 点击部署

点击 **Deploy site**，等待部署完成。

### 方法 2：手动拖拽部署

#### 4.1 准备文件

确保 `第二版` 文件夹包含所有文件：
- index.html
- admin.html
- styles.css
- script.js
- admin-script.js
- netlify.toml
- netlify/functions/ 文件夹（包含所有 API）

#### 4.2 部署

1. 登录 [Netlify Dashboard](https://app.netlify.com/)
2. 将 `第二版` 文件夹拖拽到 Netlify
3. 等待部署完成

---

## ✅ 第五步：验证部署

### 5.1 访问主页

访问：`https://your-site-name.netlify.app/index.html`

**应该看到：** 羽毛球社团管理平台主页

### 5.2 访问管理员后台

访问：`https://your-site-name.netlify.app/admin.html`

**应该看到：**
- 如果未登录，会提示"请先登录"并跳转
- 如果已登录但不是管理员，会提示无权限
- 如果是管理员，会看到管理员后台

### 5.3 测试登录

1. 在主页点击"登录"
2. 输入你的邮箱和密码
3. 登录成功后，访问 `admin.html`
4. 如果是社长，应该看到完整的管理后台

### 5.4 测试 API

打开浏览器开发者工具（F12），在 Console 中执行：

```javascript
// 测试配置 API
fetch('/.netlify/functions/config')
  .then(r => r.json())
  .then(d => console.log('配置 API 测试成功:', d));
```

**应该看到：** 返回 Supabase URL 和 anon key

---

## ✅ 第六步：首次使用

### 6.1 社长首次登录

1. 使用被任命为社长的账号登录
2. 访问 `https://your-site.netlify.app/admin.html`
3. 应该看到管理员后台，包括：
   - 待审批
   - 角色管理
   - 活动管理
   - 财务管理
   - 物资管理

### 6.2 任命其他管理员

1. 在"角色管理"标签页
2. 点击"任命管理员"
3. 选择用户和角色
4. 确认任命

### 6.3 测试审批流程

1. 使用财务账号登录
2. 在"财务管理"添加一条记录
3. 提交申请
4. 使用社长账号登录
5. 在"待审批"中看到申请
6. 批准或拒绝

---

## 🔧 常见问题排查

### 问题 1：404 Page Not Found

**可能原因：**
- netlify.toml 配置错误（已修复）
- 文件路径不正确
- 部署目录设置错误

**解决方法：**
1. 确认 `netlify.toml` 中的重定向规则已注释
2. 确认部署目录设置为 `第二版` 或 `.`
3. 重新部署

### 问题 2：API 返回 500 错误

**可能原因：**
- 环境变量未配置
- 环境变量值不正确

**解决方法：**
1. 检查 Netlify 环境变量是否正确配置
2. 检查 Supabase URL 和密钥是否正确
3. 重新部署

### 问题 3：登录后无法访问管理员后台

**可能原因：**
- 用户未被任命为管理员
- admin_roles 表未创建

**解决方法：**
1. 检查数据库中 `admin_roles` 表是否存在
2. 检查该用户是否有 `is_active = TRUE` 的记录
3. 重新任命管理员

### 问题 4：数据库查询失败

**可能原因：**
- RLS 策略未正确配置
- 表未创建

**解决方法：**
1. 重新执行 `admin_system_migration.sql`
2. 检查 Supabase 日志
3. 验证所有表和触发器已创建

---

## 📋 快速检查列表

完成以下所有项后，系统应该可以正常运行：

- [ ] 执行 `database.sql` 创建基础表
- [ ] 执行 `admin_system_migration.sql` 创建管理员表
- [ ] 任命首位社长
- [ ] 获取 Supabase URL
- [ ] 获取 Supabase anon key
- [ ] 获取 Supabase service_role key
- [ ] 在 Netlify 配置 `SUPABASE_URL` 环境变量
- [ ] 在 Netlify 配置 `SUPABASE_ANON_KEY` 环境变量
- [ ] 在 Netlify 配置 `SUPABASE_SERVICE_ROLE_KEY` 环境变量
- [ ] 部署网站到 Netlify
- [ ] 验证主页可以访问
- [ ] 验证管理员后台可以访问
- [ ] 测试登录功能
- [ ] 测试管理员功能

---

## 🎉 完成！

完成所有步骤后，你的羽毛球社团管理平台应该已经完全可用了！

如果遇到任何问题，请参考：
- `管理员系统部署指南.md` - 详细功能说明
- `排查指南.md` - 问题排查指南
- Netlify Functions 日志 - 查看 API 错误
- Supabase 日志 - 查看数据库错误
